name: ğŸš€ Docker Image CI & Push

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: ğŸ§± Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§¾ Validate Dockerfile
        run: |
          echo "ğŸ” Checking for Dockerfile..."
          if [ ! -f Dockerfile ]; then
            echo "âŒ Dockerfile not found in repository root!"
            ls -la
            exit 1
          fi
          echo "âœ… Dockerfile found successfully."

      - name: ğŸ§¹ Clean Docker cache
        run: docker system prune -af || true

      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ×× ××ª×” ×¨×•×¦×” ×œ×“×—×•×£ ×œ-GitHub Container Registry (ghcr.io)
      # ×”×—×œ×£ ××ª ×”-action ×”×–×” ×‘:
      # uses: docker/login-action@v3
      # with:
      #   registry: ghcr.io
      #   username: ${{ github.actor }}
      #   password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Build and tag Docker image
        env:
          DOCKER_BUILDKIT: 1
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/my-image
          TAG=$(date +%Y%m%d%H%M)
          echo "ğŸ·ï¸ Building $IMAGE_NAME:$TAG"
          docker build --progress=plain --file Dockerfile --tag $IMAGE_NAME:$TAG .
          echo "âœ… Build successful."

      - name: ğŸ§ª Test Docker image
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/my-image
          TAG=$(docker images --format '{{.Tag}}' | head -n 1)
          echo "ğŸ§ª Running image test..."
          docker run --rm $IMAGE_NAME:$TAG echo "âœ… Image is runnable!"

      - name: ğŸš€ Push Docker image to Docker Hub
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/my-image
          TAG=$(docker images --format '{{.Tag}}' | head -n 1)
          echo "ğŸ“¤ Pushing $IMAGE_NAME:$TAG"
          docker push $IMAGE_NAME:$TAG
          echo "âœ… Image pushed successfully."

      - name: ğŸ“¦ List Docker images
        run: docker images
